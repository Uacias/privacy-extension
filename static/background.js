import{i as P,_ as R,w as I,a as N,b as S,g as _}from"./assets/noirc_abi_wasm_bg-DJmkL4KX.js";async function O(){const e="offscreen.html";if(!chrome.offscreen)throw new Error("Offscreen API not available.");await chrome.offscreen.hasDocument()||await chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.WORKERS],justification:"Need to run zk-SNARK proof generation with Aztec bb.js in isolated context"})}const y=()=>new Promise((e,f)=>{let i=0;const n=setInterval(()=>{i++;try{chrome.runtime.connect({name:"proof-channel"}).disconnect(),clearInterval(n),e()}catch{i>=10&&(clearInterval(n),f(new Error("Offscreen not ready")))}},200)});console.log("ðŸ“¦ [background] Loaded");let c={garaga:null,ready:!1};const w=async()=>{if(!c.ready){console.log("ðŸ§  [ZK Init] Starting...");try{await P(),await R(fetch(I)),await N(fetch(S)),c.garaga=_,c.ready=!0,console.log("âœ… [ZK Init] Ready")}catch(e){console.error("âŒ [ZK Init] Failed:",e)}}},x=async()=>{c.ready||await w()};let a=null;chrome.runtime.onInstalled.addListener(()=>{console.log("ðŸ” [Service Worker] onInstalled"),w()});chrome.runtime.onMessage.addListener((e,f,i)=>(console.log("ðŸ“¨ [Message] Received:",e),(async()=>{if(await x(),e.type==="SET_SEED"){chrome.storage.session.set({decryptedSeed:e.seed},()=>{i({status:"ok"})});return}if(e.type==="GET_SEED"){chrome.storage.session.get(["decryptedSeed"],n=>{i({seed:n.decryptedSeed||null})});return}if(e.type==="GENERATE_OPERATION"){const{metadata:n}=e,o=(await chrome.storage.session.get(["decryptedSeed"])).decryptedSeed;if(!o)return i({error:"No seed unlocked"});const t=c.garaga,r=BigInt(`0x${o}`),s=await chrome.storage.local.get(["confirmedOperations","pendingOperations"]),d=s.confirmedOperations||[],p=s.pendingOperations||[],u=d.length+p.length,g=crypto.randomUUID(),l=t.poseidonHashBN254(t.poseidonHashBN254(r,r),BigInt(u)),h=t.poseidonHashBN254(l,l),E=t.poseidonHashBN254(l,h),m={id:g,index:u,secret:l.toString(),nullifier:h.toString(),hash:E.toString(),metadata:n};await chrome.storage.local.set({pendingOperations:[...p,m]}),i({id:g,hash:m.hash});return}if(e.type==="CONFIRM_OPERATION"){const{id:n}=e,o=await chrome.storage.local.get(["pendingOperations","confirmedOperations"]),t=o.pendingOperations||[],r=o.confirmedOperations||[],s=t.findIndex(p=>p?.id===n);if(s===-1)return i({status:"error",reason:"Not found"});const[d]=t.splice(s,1);r.push(d),await chrome.storage.local.set({pendingOperations:t,confirmedOperations:r}),console.log("[bg] Confirmed:",d),i({status:"confirmed"});return}if(e.type==="ABORT_OPERATION"){const{id:n}=e,r=((await chrome.storage.local.get(["pendingOperations"])).pendingOperations||[]).filter(s=>s.id!==n);await chrome.storage.local.set({pendingOperations:r}),i({status:"aborted"});return}if(e.type==="GET_CONFIRMED_OPERATIONS"&&chrome.storage.session.get(["decryptedSeed"],n=>n.decryptedSeed?(chrome.storage.local.get(["confirmedOperations"],t=>{i({operations:t.confirmedOperations||[]})}),!0):i({error:"No seed unlocked"})),e.type==="GENERATE_PROOF"){await O(),await y(),crypto.randomUUID();const n=await chrome.storage.local.get(["pendingOperations","confirmedOperations"]),o=n.pendingOperations||[],t=n.confirmedOperations||[],r={type:"GENERATE_PROOF",circuit:e.circuit,witnessInput:e.witnessInput,confirmedOperations:t,pendingOperations:o};return await chrome.storage.session.set({pendingProofRequest:r}),console.log("[background] ðŸ“¥ Stored pendingProofRequest in session"),await chrome.action.setPopup({popup:"popup.html"}),chrome.action.openPopup(),a=i,!0}if(e.type==="APPROVE_PROOF")return chrome.storage.session.get(["pendingProofRequest"],async n=>{const o=n.pendingProofRequest;if(!o){a&&(a({error:"No request found"}),a=null),chrome.action.setPopup({popup:"index.html"});return}chrome.storage.session.remove("pendingProofRequest",async()=>{try{await O(),await y();const t=chrome.runtime.connect({name:"proof-channel"});t.postMessage({type:"GENERATE_PROOF",circuit:o.circuit,witnessInput:o.witnessInput,confirmedOperations:o.confirmedOperations,pendingOperations:o.pendingOperations}),t.onMessage.addListener(r=>{r.type==="PROOF_RESPONSE"?(a&&(a({proof:r.honkCalldataHex}),a=null),chrome.action.setPopup({popup:"index.html"})):r.type==="PROOF_ERROR"&&(a&&(a({error:r.error}),a=null),chrome.action.setPopup({popup:"index.html"}))})}catch(t){a&&(a({error:t.message||String(t)}),a=null),chrome.action.setPopup({popup:"index.html"})}})}),!0})(),!0));
